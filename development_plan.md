# テキストマージGUIツール 開発計画書

## 1. 目的
複数のテキストファイルを読み込み、ユーザーがGUI上で指定した順序でマージし、指定文字コードで保存するWindows向けツールを作成する。

## 2. 前提・対象
- 対象プラットフォーム: Windows
- 実装方式: .NET デスクトップアプリ（WPF）
- 主用途: ローカルファイルの手動マージ

## 3. 機能要件
### 3.1 入力
- 複数ファイルをGUIから追加できること
- エクスプローラからファイル一覧へドラッグ＆ドロップで追加できること
- フォルダ指定で再帰的にファイルを取り込みできること
- ファイル一覧の順序をマージ順として扱うこと
- ファイル順序は以下で変更できること
  - 一覧内ドラッグ＆ドロップ
  - 補助として「上へ」「下へ」ボタン

### 3.2 文字コード（入力/出力）
- Shift_JIS
- CP932
- UTF-8（BOMなし）
- UTF-8（BOMあり）
- 入力時は文字コード自動判定に対応すること

### 3.3 マージ
- ファイル一覧の順番で連結すること
- 空行はそのまま保持すること
- 文字列内容の自動整形（trim、空行削除など）は行わないこと

### 3.4 出力
- 出力先ファイルパスを指定できること
- 出力文字コードを選択できること
- 既定値は UTF-8（BOMなし）とすること
- 出力改行コードを LF / CRLF から選択できること
- 出力改行コードの既定値は CRLF とすること

### 3.5 エラーハンドリング
- 読み込み失敗ファイルを明示すること
- 文字コード不一致や不正バイト時はエラー内容を表示すること
- 実行結果として成功/失敗件数を表示すること

## 4. 非機能要件
- 大きめのファイルでもUIが固まりにくいこと（非同期実行）
- 操作が直感的であること（一覧＋ボタン中心）
- 主要処理をUI層と分離し、テスト可能な構成にすること

## 5. 画面仕様（初版）
### 5.1 メイン画面
- ファイル一覧（列: 順序、ファイルパス、選択文字コード）
- ボタン: 追加、削除、上へ、下へ
- ファイル追加: エクスプローラから一覧へドラッグ＆ドロップ対応
- フォルダ追加: 指定フォルダ配下を再帰取り込み
- 並び替え: 一覧内ドラッグ＆ドロップ
- 出力設定: 出力先パス、出力文字コード
- 実行: マージ開始ボタン
- ステータス表示: 進捗、結果メッセージ

### 5.2 補助ダイアログ
- ファイル選択ダイアログ（複数選択）
- 出力先保存ダイアログ
- エラー詳細ダイアログ

## 6. 技術設計
### 6.1 構成
- `KabooTextMerger`（WPF）
- `TextMerger.Core`（文字コード処理、マージ処理、入出力）

### 6.2 主要コンポーネント
- `FileEntry`: ファイルパス、入力文字コード、表示順を保持
- `InputCollector`: ファイル/フォルダ入力と再帰列挙
- `EncodingService`: エンコーディング解決（Shift_JIS / CP932 / UTF-8 BOM有無、自動判定）
- `MergeService`: 指定順でファイルを読み込み、テキスト結合
- `OutputService`: 指定エンコードで保存
- `ResultReport`: 処理結果（成功/失敗、メッセージ）

### 6.3 文字コード実装方針
- .NET の `Encoding.RegisterProvider(CodePagesEncodingProvider.Instance)` を利用
- BOMありUTF-8はBOMで判定する
- BOMなしは UTF-8 / Shift_JIS / CP932 の順で検証デコードし、不正バイト率が最小の候補を採用する
- 判定不能時はユーザー指定の既定入力エンコードにフォールバックする
- UTF-8 BOM有無は出力時に `new UTF8Encoding(true/false)` で切り替え

## 7. テスト計画
### 7.1 単体テスト
- 文字コード別の読み込み・書き出し
- 文字コード自動判定（UTF-8 BOM有無、Shift_JIS、CP932）
- BOM有無の出力検証
- 空行保持の検証
- 並び順どおり連結されることの検証

### 7.2 結合テスト
- GUI操作で追加→並び替え→出力までの正常系
- エクスプローラからのドラッグ＆ドロップ追加の正常系
- フォルダ再帰取り込みの正常系
- 読み込み不可ファイルが含まれる異常系

### 7.3 受け入れ基準
- 指定4種の文字コードで入力/出力できる
- 文字コード自動判定で入力できる
- エクスプローラからのドラッグ＆ドロップでファイル追加できる
- フォルダ再帰取り込みでファイル追加できる
- 一覧内ドラッグ＆ドロップで順序変更でき、結果に反映される
- 空行が元テキストどおり出力される
- 既定出力が UTF-8（BOMなし）である

## 8. 開発マイルストーン
1. 画面骨組み実装（ファイル一覧、出力設定、実行ボタン）
2. コア処理実装（読み込み、連結、保存）
3. 並び替え実装（上下ボタン、ドラッグ＆ドロップ）
4. エラー表示と結果レポート実装
5. テスト整備と初版リリース

## 9. 初版スコープ外
- なし
